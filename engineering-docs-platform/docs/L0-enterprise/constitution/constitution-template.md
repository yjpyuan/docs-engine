<!--
  SYNC IMPACT REPORT
  Version Change: 3.0.0 → 3.1.0 (MINOR - 扩展架构与模块设计原则)
  Modified Principles:
    - III. 分层架构纯粹性 → III. 架构与模块设计（扩展为 9 层架构 + 模块设计原则）
  Added Content:
    - 9 层架构图（接入层 → 通用模块层）
    - 层级职责说明表格
    - 层级依赖规则（4 条禁止项）
    - 模块设计原则（单一职责、松耦合、高内聚、关注点分离、最小依赖）
  Previous Changes (3.0.0):
    - 精简重构，合并重叠原则，下沉实现细节至 L1
    - 创建 L1 技术栈文档：.knowledge/upstream/L1-project/standards/tech-stack.md
-->

# 项目章程

> 企业级技术宪法 - 下级项目/仓库不可覆盖的强制约束

## 核心原则

### I. 测试驱动开发

**强制要求**：所有代码必须遵循测试驱动开发流程，测试优先，实现在后。

- 每个 Controller、Service、Mapper 必须有对应测试类
- 核心业务逻辑测试覆盖率 ≥ 80%，工具类 ≥ 90%
- 必须使用 AAA 模式（Arrange-Act-Assert）
- **禁止**：跳过测试、TODO 标记、注释掉测试代码

**理由**：TDD 确保代码质量和业务逻辑正确性，降低生产环境风险。

### II. 规则至上架构

**规则执行优先级**：L0（企业级）> L1（项目级）> L2（仓库级），必须零偏差执行。

- L0 约束不可被下级覆盖
- 严格按规则定义的目录和包结构创建文件
- 遇到错误必须立即停止、删除错误文件、重新按规则执行
- **默认文档目录**：若无明确指定输出目录，且非 CLAUDE.md、AGENTS.md 等框架配置文档的更新，所有生成的文档默认存放于 `.knowledge/` 目录

**理由**：确保代码库一致性和团队协作效率，避免架构腐化。

### III. 架构与模块设计

**分层架构约束**：项目采用分层架构设计，通过模块化组织代码，支持业务场景的灵活扩展。

```
┌─────────────────────────────────────────────────────────────┐
│                      接入层                                  │  ← 请求接入、协议转换
├─────────────────────────────────────────────────────────────┤
│                    解决方案层                                │  ← 业务解决方案统一入口
├─────────────────────────────────────────────────────────────┤
│                   子解决方案层                               │  ← 细粒度业务处理能力
├─────────────────────────────────────────────────────────────┤
│                   模块构建层                                 │  ← 按业务功能划分的模块构建器
├─────────────────────────────────────────────────────────────┤
│                   数据服务层                                 │  ← 业务数据获取、处理、封装
├─────────────────────────────────────────────────────────────┤
│                   外部服务层                                 │  ← 外部服务调用、模型转换
├─────────────────────────────────────────────────────────────┤
│                   领域模型层                                 │  ← 核心业务对象、DTO 定义
├─────────────────────────────────────────────────────────────┤
│                   基础设施层                                 │  ← 基础组件、框架封装
├─────────────────────────────────────────────────────────────┤
│                   通用模块层                                 │  ← 公共组件、工具类
└─────────────────────────────────────────────────────────────┘
```

**层级职责说明**：

| 层级 | 职责 | 典型组件 |
|------|------|----------|
| 接入层 | 处理请求接入和协议转换 | Controller、Gateway、Filter |
| 解决方案层 | 业务解决方案的统一入口 | Facade、Orchestrator |
| 子解决方案层 | 细粒度的业务处理能力 | SubSolution、Handler |
| 模块构建层 | 按业务功能划分的模块构建器 | Builder、Assembler |
| 数据服务层 | 业务数据的获取、处理和封装 | DataService、Repository |
| 外部服务层 | 调用外部服务并进行模型转换 | Client、Adapter、Converter |
| 领域模型层 | 核心业务对象和数据传输对象 | Entity、DTO、VO |
| 基础设施层 | 基础组件和框架封装 | Cache、MQ、Config |
| 通用模块层 | 公共组件和工具类 | Utils、Constants、Enums |

**层级依赖规则**：

- 上层可依赖下层，**禁止**下层依赖上层
- 同层之间通过接口交互，**禁止**直接依赖实现
- **禁止**：跨层直接调用（如接入层直接访问数据服务层）
- **禁止**：循环依赖（A→B→C→A）

**模块设计原则**：

- **单一职责**：每个模块有且仅有一个明确目的，一个变更理由
- **松耦合**：模块间通过接口交互，降低相互依赖
- **高内聚**：模块内部实现自洽，相关功能聚合在一起
- **关注点分离**：模块边界与业务能力、领域上下文对齐
- **最小依赖**：仅导入必要依赖，减少系统复杂性

**理由**：清晰的分层和模块边界降低系统复杂度，支持业务场景灵活扩展和独立演进。

### IV. 安全与合规

**安全红线**：

- **禁止**：硬编码密码、API Key、Token、证书
- **禁止**：日志输出敏感信息（密码、身份证、手机号、银行卡）
- **禁止**：MD5/SHA1 加密密码（必须 BCrypt/Argon2）
- **禁止**：SQL 字符串拼接（必须参数化查询）、MyBatis 使用 `${}`
- **禁止**：直接输出用户输入到页面（XSS 防护）

**合规要求（个保法/GDPR/等保 2.0）**：

- 敏感操作必须后端强制校验授权状态，授权记录持久化存证
- 用户注销必须全链路删除（MySQL/Redis/ES/OSS），删除后校验清理结果
- 敏感操作必须双因素认证，遵循最小权限原则
- 数据分级加密：核心（SM4+信封加密）、重要（AES-256）、一般（可逆脱敏）

**理由**：安全与合规是企业生存底线，违规将面临重大损失。

### V. RESTful API 标准化

**API 设计规范**：

- 资源化路径（`/users` 而非 `/getUsers`），URL 名词复数、全小写、连字符分隔
- 版本号放在路径中（`/api/v1/`）
- 统一响应格式（code/msg/data/timestamp）
- 必须使用 OpenAPI 3 生成 API 文档

**理由**：统一 API 规范降低联调成本，提升可维护性。

### VI. 生产就绪代码完整性

**代码质量标准**：

- 代码必须可编译、可运行、可测试
- **禁止**：TODO 标记、简化实现、占位代码
- 必须包含完整的错误处理、日志记录、参数验证
- 必须遵循 SOLID 原则

**理由**：半成品代码增加技术债务，降低系统稳定性。

### VII. 运维就绪

**可观测性**：

- 所有服务必须暴露健康检查端点（/actuator/health）
- 关键业务流程必须有全链路追踪（TraceId 贯穿）
- 异常必须上报监控系统，**禁止**静默吞掉
- 日志格式必须包含 traceId，**禁止**明文打印敏感数据

**容错韧性**：

- 外部依赖调用必须设置超时时间
- 核心链路必须有降级方案
- **禁止**单点故障（数据库、缓存、MQ 等）
- 链路 ID 必须在服务间传递

**理由**：可观测性和容错能力是生产系统稳定运行的基础。

### VIII. 数据治理

**事务规范**：

- **禁止**：在数据库事务中调用外部 HTTP 服务
- 所有写接口必须支持幂等性（可安全重试）
- 并发修改必须有乐观锁或悲观锁保护
- @Transactional 必须指定 rollbackFor = Exception.class

**审计追踪**：

- 关键操作必须记录审计日志（who/when/what/where/result）
- 审计日志禁止删除或篡改，保留期限 ≥6 个月
- 登录失败、权限变更、数据导出必须记录

**理由**：数据一致性和审计追踪是金融系统的生命线。

### IX. 简洁性原则

**YAGNI 与 KISS**：

- **禁止**引入未使用的依赖和框架
- 设计模式应用必须有明确业务场景支撑
- 避免过度抽象和过早优化
- 配置必须外部化，支持多环境（dev/test/staging/prod）

**理由**：简洁的系统更容易理解、测试和维护。

### X. SpecKit 中文本地化

**本地化要求**：

- `.specify/` 和 `specs/` 目录下的文件必须使用中文
- 模板文件、项目记忆文件必须使用中文
- 代码注释：核心业务逻辑使用中文，技术实现可用英文

**国际化保留**：

- 面向用户的 UI 组件保留 i18n 支持能力
- API 响应消息和错误码描述支持国际化

**理由**：中文本地化降低本地开发团队理解成本，同时保留国际化能力。

## 治理规则

### 章程管理

- **章程地位**：本章程优先级高于所有其他实践和约定
- **修订流程**：修订需文档化、审批、制定迁移计划
- **版本控制**：MAJOR（原则移除/重定义）、MINOR（新增原则）、PATCH（澄清/修正）

### 合规检查

- 所有 PR 必须验证章程符合性
- 安全相关变更必须安全团队 Review
- 架构变更必须架构委员会审批
- 数据库 Schema 变更必须 DBA Review

### 质量门禁

- **代码审查**：所有代码必须 Peer Review
- **测试覆盖率**：核心业务 ≥ 80%，工具类 ≥ 90%
- **静态检查**：必须通过 CheckStyle、SonarQube（无 Critical/Blocker）
- **安全扫描**：依赖漏洞扫描（CVSS ≥ 7 阻断）
- **性能基准**：关键接口响应时间 < 200ms（P95）

### 发布流程

- 生产发布必须经过 staging 环境验证
- 发布必须有可执行的回滚方案
- 业务高峰期禁止发布
- 灰度发布：先 1 个 Pod，观察 10 分钟，再扩展

---

**版本**：3.1.0 | **批准日期**：2025-11-27 | **最后修订**：2025-12-24
