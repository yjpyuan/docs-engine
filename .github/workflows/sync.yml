name: Sync L0 Enterprise Docs

on:
  repository_dispatch:
    types: [sync-L0]  # ç›‘å¬æ¥è‡ª L0 ä»“åº“çš„ sync-l0 äº‹ä»¶
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # èµ‹äºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ¨é€ gh-pages åˆ†æ”¯
  id-token: write

jobs:
  sync-l0:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs-engine repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Debug git auth
        run: |
          git remote -v
          git config --list | grep -i credential || true

      # - name: Setup Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #     cache-dependency-path: engineering-docs-platform/package-lock.json

      # - name: Install rsync
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y rsync

      # - name: Sync L0 Repository
      #   run: |
      #     # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
      #     chmod +x ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ‰§è¡ŒåŒæ­¥è„šæœ¬
      #     ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ˜¾ç¤ºåŒæ­¥ç»“æœ
      #     echo "==> Synced files:"
      #     ls -la engineering-docs-platform/docs/L0-enterprise/

      # - name: Commit synced content
      #   run: |
      #     # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"

      #     # æ·»åŠ  docs ç›®å½•çš„æ‰€æœ‰å˜æ›´
      #     git add engineering-docs-platform/docs/

      #     # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      #     if git diff --staged --quiet; then
      #       echo "No changes to commit"
      #     else
      #       # è¯»å– _meta.json è·å–æºä»“åº“ commit ä¿¡æ¯
      #       COMMIT_SHORT=$(grep '"short"' engineering-docs-platform/docs/L0-enterprise/_meta.json | cut -d'"' -f4)

      #       # æäº¤å˜æ›´ï¼ˆä½¿ç”¨ HEREDOC æ”¯æŒå¤šè¡Œ commit messageï¼‰
      #       git commit -m "$(cat <<EOF
      #     sync(docs): sync L0-enterprise@${COMMIT_SHORT}

      #     Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
      #     EOF
      #     )"

      #       # æ¨é€åˆ°è¿œç¨‹ä»“åº“
      #       git push

      #       echo "Changes committed and pushed successfully"
      #     fi
      
      - name: Debug env
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ANTHROPIC_API_KEY length: ${#ANTHROPIC_API_KEY}"
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is EMPTY"
          else
            echo "ANTHROPIC_API_KEY is PRESENT"
          fi

      # =========================
      # ğŸ¤– Claude Code å®˜æ–¹ Action
      # =========================
      - name: Run Claude Code (Extract / Refactor Common Docs)
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools Edit,Read,Write
          prompt: |
            è¯·æ£€æŸ¥è·¯å¾„ï¼šengineering-docs-platform/docs/L0-enterprise/test.md
            
            1. å¦‚æœæ–‡ä»¶ã€å·²ç»å­˜åœ¨ã€‘ï¼š
               - è¯·åŠ¡å¿…å…ˆè¯»å– (Read) è¯¥æ–‡ä»¶å†…å®¹ã€‚
               - ç„¶åç›´æ¥è¦†ç›– (Overwrite) ä¸ºæ–°å†…å®¹ã€‚
            2. å¦‚æœæ–‡ä»¶ã€ä¸å­˜åœ¨ã€‘ï¼š
               - è¯·ç›´æ¥åˆ›å»ºå¹¶å†™å…¥æ–°å†…å®¹ã€‚
            
            æ–°å†…å®¹è¦æ±‚ï¼š
            hello world ï¼ŒåŠ ä¸Šä½ æƒ³å’Œæˆ‘è¯´çš„è¯400å­—ã€‚
            
            æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµç¨‹ï¼Œæ— è®ºå“ªç§æƒ…å†µéƒ½è¯·ç›´æ¥æ‰§è¡Œï¼Œä¸è¦æé—®ã€‚
      # - name: Install Claude Code CLI
      #   run: npm install -g @anthropic-ai/claude-code
   
      # - name: Run Claude Code via CLI
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #     ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
      #   run: |
      #     claude --dangerously-skip-permissions <<'EOF'
      #     åˆ›å»º engineering-docs-platform/docs/L0-enterprise/test.md
      #     å†…å®¹ï¼š
      #     hello worldï¼Œå’Œä½ æƒ³å’Œæˆ‘è¯´çš„è¯ï¼Œæœ€å°‘200å­—
      #     EOF


      # - name: Force set git remote with token
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/yjpyuan/docs-engine.git

      # æäº¤ Claude è‡ªåŠ¨ç”Ÿæˆ/ä¿®æ”¹çš„å†…å®¹
      # - name: Commit Claude changes
      #   run: |
      #     git config user.name "ai-bot"
      #     git config user.email "ai-bot@users.noreply.github.com"

      #     git add .

      #     if git diff --staged --quiet; then
      #       echo "No AI changes to commit"
      #     else
      #       git commit -m "ai(docs): extract common content via Claude"
      #       git push
      #       echo "Claude changes committed and pushed"
      #     fi

      # ç¬¬äºŒæ­¥ï¼šç”± AI è´Ÿè´£ Git æäº¤
      - name: Claude Git Commit
        id: claude_commit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # è¿™ä¸€æ­¥å¿…é¡»å¼€å¯ Shell æƒé™
          claude_args: "--allowedTools Shell,Read"
          prompt: |
            è¯·æ‰§è¡Œä»¥ä¸‹ Git æ“ä½œï¼š
            1. ä½¿ç”¨ Shell å‘½ä»¤é…ç½® Git ç”¨æˆ·ï¼šname "ai-bot", email "ai-bot@users.noreply.github.com"ã€‚
            2. æ‰§è¡Œ `git add .`ã€‚
            3. æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„æ›´æ”¹ï¼š
               - å¦‚æœæœ‰ï¼Œè¯·æ ¹æ®ä½ åˆšæ‰ä¿®æ”¹çš„å†…å®¹ï¼Œæ’°å†™ä¸€ä¸ªç®€çŸ­ä¸“ä¸šçš„ commit message å¹¶æ‰§è¡Œ `git commit`ã€‚
               - ç„¶åæ‰§è¡Œ `git push`ã€‚
               - å¦‚æœæ²¡æœ‰æ›´æ”¹ï¼Œç›´æ¥è¾“å‡º "No changes to commit"ã€‚
            æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–ç¯å¢ƒï¼Œè¯·ç›´æ¥é€šè¿‡ Shell å·¥å…·æ‰§è¡Œå‘½ä»¤ï¼Œä¸è¦è¯¢é—®æˆ‘ã€‚

      # - name: Install dependencies
      #   working-directory: ./engineering-docs-platform

      # - name: Build Documentation
      #   working-directory: ./engineering-docs-platform
      #   run: npm run build

      # - name: Deploy to GitHub Pages
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     branch: gh-pages
      #     folder: engineering-docs-platform/build
      #     clean: true
