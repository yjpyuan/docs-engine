name: Sync L0 Enterprise Docs

on:
  repository_dispatch:
    types: [sync-L0]  # ç›‘å¬æ¥è‡ª L0 ä»“åº“çš„ sync-l0 äº‹ä»¶
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # èµ‹äºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ¨é€ gh-pages åˆ†æ”¯
  id-token: write

jobs:
  sync-l0:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs-engine repository
        uses: actions/checkout@v3

      # - name: Setup Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #     cache-dependency-path: engineering-docs-platform/package-lock.json

      # - name: Install rsync
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y rsync

      # - name: Sync L0 Repository
      #   run: |
      #     # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
      #     chmod +x ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ‰§è¡ŒåŒæ­¥è„šæœ¬
      #     ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ˜¾ç¤ºåŒæ­¥ç»“æœ
      #     echo "==> Synced files:"
      #     ls -la engineering-docs-platform/docs/L0-enterprise/

      # - name: Commit synced content
      #   run: |
      #     # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"

      #     # æ·»åŠ  docs ç›®å½•çš„æ‰€æœ‰å˜æ›´
      #     git add engineering-docs-platform/docs/

      #     # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      #     if git diff --staged --quiet; then
      #       echo "No changes to commit"
      #     else
      #       # è¯»å– _meta.json è·å–æºä»“åº“ commit ä¿¡æ¯
      #       COMMIT_SHORT=$(grep '"short"' engineering-docs-platform/docs/L0-enterprise/_meta.json | cut -d'"' -f4)

      #       # æäº¤å˜æ›´ï¼ˆä½¿ç”¨ HEREDOC æ”¯æŒå¤šè¡Œ commit messageï¼‰
      #       git commit -m "$(cat <<EOF
      #     sync(docs): sync L0-enterprise@${COMMIT_SHORT}

      #     Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
      #     EOF
      #     )"

      #       # æ¨é€åˆ°è¿œç¨‹ä»“åº“
      #       git push

      #       echo "Changes committed and pushed successfully"
      #     fi
      
      - name: Debug env
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ANTHROPIC_API_KEY length: ${#ANTHROPIC_API_KEY}"
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is EMPTY"
          else
            echo "ANTHROPIC_API_KEY is PRESENT"
          fi
      # =========================
      # ğŸ¤– Claude Code å®˜æ–¹ Action
      # =========================
      # - name: Run Claude Code (Extract / Refactor Common Docs)
      #   id: claude
      #   uses: anthropics/claude-code-action@v1
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #     ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
      #   with:
      #     mode: cli
      #     prompt: |
      #       ç”Ÿæˆä¸€ä¸ª test.md æ–‡ä»¶
      #       è·¯å¾„ï¼šengineering-docs-platform/docs/L0-enterprise/test.md
      #       å†…å®¹ï¼š
      #       hello world
      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code
   
      - name: Run Claude Code via CLI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
        run: |
          claude --non-interactive --yes --dangerously-skip-permissions <<'EOF'
          åˆ›å»º engineering-docs-platform/docs/L0-enterprise/test.md
          å†…å®¹ï¼š
          hello worldï¼Œå’Œä½ æƒ³å’Œæˆ‘è¯´çš„è¯ï¼Œæœ€å°‘200å­—
          EOF



      # æäº¤ Claude è‡ªåŠ¨ç”Ÿæˆ/ä¿®æ”¹çš„å†…å®¹
      - name: Commit Claude changes
        run: |
          git config user.name "ai-bot"
          git config user.email "ai-bot@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "No AI changes to commit"
          else
            git commit -m "ai(docs): extract common content via Claude"
            git push
            echo "Claude changes committed and pushed"
          fi

      # - name: Install dependencies
      #   working-directory: ./engineering-docs-platform
      #   run: npm ci

      # - name: Build Documentation
      #   working-directory: ./engineering-docs-platform
      #   run: npm run build

      # - name: Deploy to GitHub Pages
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     branch: gh-pages
      #     folder: engineering-docs-platform/build
      #     clean: true
