name: Sync L0 Enterprise Docs

on:
  repository_dispatch:
    types: [sync-L0]  # ç›‘å¬æ¥è‡ª L0 ä»“åº“çš„ sync-l0 äº‹ä»¶
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # èµ‹äºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ¨é€ gh-pages åˆ†æ”¯
  id-token: write

jobs:
  sync-l0:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs-engine repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Debug git auth
        run: |
          git remote -v
          git config --list | grep -i credential || true

      # - name: Setup Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '20'
      #     cache: 'npm'
      #     cache-dependency-path: engineering-docs-platform/package-lock.json

      # - name: Install rsync
      #   run: |
      #     sudo apt-get update
      #     sudo apt-get install -y rsync

      # - name: Sync L0 Repository
      #   run: |
      #     # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
      #     chmod +x ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ‰§è¡ŒåŒæ­¥è„šæœ¬
      #     ./knowledge-pipeline/sync/sync-l0.sh

      #     # æ˜¾ç¤ºåŒæ­¥ç»“æœ
      #     echo "==> Synced files:"
      #     ls -la engineering-docs-platform/docs/L0-enterprise/

      # - name: Commit synced content
      #   run: |
      #     # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"

      #     # æ·»åŠ  docs ç›®å½•çš„æ‰€æœ‰å˜æ›´
      #     git add engineering-docs-platform/docs/

      #     # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      #     if git diff --staged --quiet; then
      #       echo "No changes to commit"
      #     else
      #       # è¯»å– _meta.json è·å–æºä»“åº“ commit ä¿¡æ¯
      #       COMMIT_SHORT=$(grep '"short"' engineering-docs-platform/docs/L0-enterprise/_meta.json | cut -d'"' -f4)

      #       # æäº¤å˜æ›´ï¼ˆä½¿ç”¨ HEREDOC æ”¯æŒå¤šè¡Œ commit messageï¼‰
      #       git commit -m "$(cat <<EOF
      #     sync(docs): sync L0-enterprise@${COMMIT_SHORT}

      #     Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
      #     EOF
      #     )"

      #       # æ¨é€åˆ°è¿œç¨‹ä»“åº“
      #       git push

      #       echo "Changes committed and pushed successfully"
      #     fi
      
      - name: Debug env
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ANTHROPIC_API_KEY length: ${#ANTHROPIC_API_KEY}"
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY is EMPTY"
          else
            echo "ANTHROPIC_API_KEY is PRESENT"
          fi

      # =========================
      # ğŸ¤– Claude Code å®˜æ–¹ Action
      # =========================
      - name: Run Claude Code (Extract / Refactor Common Docs)
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(bun:*),Bash(npm:*),Bash(npx:*),Bash(gh:*)
          prompt: |
            Task 1: Content Update
            - Check path: engineering-docs-platform/docs/L0-enterprise/test.md
            - If exists, Read then Overwrite. If not, Create.
            - Content: "hello world" followed by your 400-character reflection on AI collaboration.
            
            Task 2: Git Operations (Run via Shell tool)
            - Run: git config --global user.name "ai-bot"
            - Run: git config --global user.email "ai-bot@users.noreply.github.com"
            # è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ token ç¡®ä¿é‰´æƒ
            - Run: git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            - Run: git add .
            - Run: git diff --staged --quiet || (git commit -m "ai(docs): update via Claude" && git push origin HEAD)
            
            Note: This is a CI environment. Execute all steps without asking.
      # - name: Install Claude Code CLI
      #   run: npm install -g @anthropic-ai/claude-code
   
      # - name: Run Claude Code via CLI
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #     ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
      #   run: |
      #     claude --dangerously-skip-permissions <<'EOF'
      #     åˆ›å»º engineering-docs-platform/docs/L0-enterprise/test.md
      #     å†…å®¹ï¼š
      #     hello worldï¼Œå’Œä½ æƒ³å’Œæˆ‘è¯´çš„è¯ï¼Œæœ€å°‘200å­—
      #     EOF


      - name: Force set git remote with token
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/yjpyuan/docs-engine.git

      # æäº¤ Claude è‡ªåŠ¨ç”Ÿæˆ/ä¿®æ”¹çš„å†…å®¹
      # - name: Commit Claude changes
      #   run: |
      #     git config user.name "ai-bot"
      #     git config user.email "ai-bot@users.noreply.github.com"

      #     git add .

      #     if git diff --staged --quiet; then
      #       echo "No AI changes to commit"
      #     else
      #       git commit -m "ai(docs): extract common content via Claude"
      #       git push
      #       echo "Claude changes committed and pushed"
      #     fi

      # ç¬¬äºŒæ­¥ï¼šç”± AI è´Ÿè´£ Git æäº¤
      # - name: Claude Git Commit
      #   id: claude_commit
      #   uses: anthropics/claude-code-action@v1
      #   env:
      #     ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      #     ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
      #     # æ³¨å…¥ GITHUB_TOKEN ç¡®ä¿ git push æœ‰æƒé™æ‰§è¡Œ
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      #     claude_args: "--allowedTools Edit,Read,Write,Shell --yes --verbose"
      #     # claude_args: "--allowedTools 'Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(bun:*),Bash(npm:*),Bash(npx:*),Bash(gh:*)'"
      #     # ç›´æ¥è°ƒç”¨ä½ å®šä¹‰çš„å‘½ä»¤æ–‡ä»¶åï¼ˆå»æ‰ .md åç¼€ï¼‰
      #     prompt: "/ai-commit"

      # - name: Install dependencies
      #   working-directory: ./engineering-docs-platform

      # - name: Build Documentation
      #   working-directory: ./engineering-docs-platform
      #   run: npm run build

      # - name: Deploy to GitHub Pages
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     branch: gh-pages
      #     folder: engineering-docs-platform/build
      #     clean: true
