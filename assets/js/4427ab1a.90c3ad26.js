"use strict";(globalThis.webpackChunkw3bank_knowledge_wiki=globalThis.webpackChunkw3bank_knowledge_wiki||[]).push([[2341],{2219(e,n,r){r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"L0-enterprise/constitution/architecture-principles","title":"\u67b6\u6784\u5e95\u7ebf\u89c4\u8303","description":"\u4f01\u4e1a\u7ea7\u5f3a\u5236\u7ea6\u675f\uff0c\u4e0b\u7ea7\u77e5\u8bc6\u5e93\uff08L1/L2\uff09\u4e0d\u53ef\u8986\u76d6","source":"@site/docs/L0-enterprise/constitution/architecture-principles.md","sourceDirName":"L0-enterprise/constitution","slug":"/L0-enterprise/constitution/architecture-principles","permalink":"/docs-engine/docs/L0-enterprise/constitution/architecture-principles","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/L0-enterprise/constitution/architecture-principles.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"AI \u7f16\u7801\u7b56\u7565\u89c4\u8303","permalink":"/docs-engine/docs/L0-enterprise/ai-coding/ai-coding-policy"},"next":{"title":"\u5408\u89c4\u6027\u8981\u6c42\u89c4\u8303","permalink":"/docs-engine/docs/L0-enterprise/constitution/compliance-requirements"}}');var d=r(4848),t=r(8453);const i={},s="\u67b6\u6784\u5e95\u7ebf\u89c4\u8303",a={},c=[{value:"\u4e00\u3001\u5206\u5c42\u67b6\u6784 [MUST]",id:"\u4e00\u5206\u5c42\u67b6\u6784-must",level:2},{value:"1.1 \u5c42\u7ea7\u4f9d\u8d56\u89c4\u5219",id:"11-\u5c42\u7ea7\u4f9d\u8d56\u89c4\u5219",level:3},{value:"1.2 \u7981\u6b62\u6a21\u5f0f",id:"12-\u7981\u6b62\u6a21\u5f0f",level:3},{value:"\u4e8c\u3001\u6570\u636e\u4e00\u81f4\u6027 [MUST]",id:"\u4e8c\u6570\u636e\u4e00\u81f4\u6027-must",level:2},{value:"2.1 \u4e8b\u52a1\u89c4\u8303",id:"21-\u4e8b\u52a1\u89c4\u8303",level:3},{value:"2.2 \u4e8b\u52a1\u8fb9\u754c",id:"22-\u4e8b\u52a1\u8fb9\u754c",level:3},{value:"2.3 \u4e8b\u52a1\u914d\u7f6e",id:"23-\u4e8b\u52a1\u914d\u7f6e",level:3},{value:"2.4 \u4e50\u89c2\u9501",id:"24-\u4e50\u89c2\u9501",level:3},{value:"\u4e09\u3001\u53ef\u89c2\u6d4b\u6027 [MUST]",id:"\u4e09\u53ef\u89c2\u6d4b\u6027-must",level:2},{value:"3.1 \u5065\u5eb7\u68c0\u67e5",id:"31-\u5065\u5eb7\u68c0\u67e5",level:3},{value:"3.2 K8s \u63a2\u9488\u914d\u7f6e",id:"32-k8s-\u63a2\u9488\u914d\u7f6e",level:3},{value:"3.3 \u94fe\u8def\u8ffd\u8e2a",id:"33-\u94fe\u8def\u8ffd\u8e2a",level:3},{value:"3.4 \u65e5\u5fd7\u683c\u5f0f\u89c4\u8303",id:"34-\u65e5\u5fd7\u683c\u5f0f\u89c4\u8303",level:3},{value:"3.4.1 Logback \u914d\u7f6e",id:"341-logback-\u914d\u7f6e",level:4},{value:"3.4.2 \u65e5\u5fd7\u5b57\u6bb5\u89c4\u8303",id:"342-\u65e5\u5fd7\u5b57\u6bb5\u89c4\u8303",level:4},{value:"3.4.3 TraceId \u751f\u6210\u4e0e\u4f20\u9012",id:"343-traceid-\u751f\u6210\u4e0e\u4f20\u9012",level:4},{value:"3.4.4 \u65e5\u5fd7\u7ea7\u522b\u4f7f\u7528\u89c4\u8303",id:"344-\u65e5\u5fd7\u7ea7\u522b\u4f7f\u7528\u89c4\u8303",level:4},{value:"3.4.5 \u654f\u611f\u6570\u636e\u8131\u654f",id:"345-\u654f\u611f\u6570\u636e\u8131\u654f",level:4},{value:"\u56db\u3001\u5bb9\u9519\u97e7\u6027 [MUST]",id:"\u56db\u5bb9\u9519\u97e7\u6027-must",level:2},{value:"4.1 \u8d85\u65f6\u4e0e\u7194\u65ad",id:"41-\u8d85\u65f6\u4e0e\u7194\u65ad",level:3},{value:"4.2 Feign \u8d85\u65f6\u914d\u7f6e",id:"42-feign-\u8d85\u65f6\u914d\u7f6e",level:3},{value:"4.3 \u7194\u65ad\u964d\u7ea7",id:"43-\u7194\u65ad\u964d\u7ea7",level:3},{value:"\u4e94\u3001\u5fae\u670d\u52a1\u901a\u4fe1 [MUST]",id:"\u4e94\u5fae\u670d\u52a1\u901a\u4fe1-must",level:2},{value:"5.1 \u6ce8\u518c\u4e2d\u5fc3",id:"51-\u6ce8\u518c\u4e2d\u5fc3",level:3},{value:"5.2 Feign \u89c4\u8303",id:"52-feign-\u89c4\u8303",level:3},{value:"\u516d\u3001\u5bb9\u5668\u5316\u90e8\u7f72 [MUST]",id:"\u516d\u5bb9\u5668\u5316\u90e8\u7f72-must",level:2},{value:"6.1 Dockerfile \u89c4\u8303",id:"61-dockerfile-\u89c4\u8303",level:3},{value:"6.2 K8s \u5b89\u5168\u914d\u7f6e",id:"62-k8s-\u5b89\u5168\u914d\u7f6e",level:3},{value:"6.3 \u955c\u50cf\u6807\u7b7e\u89c4\u8303",id:"63-\u955c\u50cf\u6807\u7b7e\u89c4\u8303",level:3},{value:"\u4e03\u3001\u53cd\u6a21\u5f0f\u68c0\u67e5\u6e05\u5355",id:"\u4e03\u53cd\u6a21\u5f0f\u68c0\u67e5\u6e05\u5355",level:2}];function o(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"\u67b6\u6784\u5e95\u7ebf\u89c4\u8303",children:"\u67b6\u6784\u5e95\u7ebf\u89c4\u8303"})}),"\n",(0,d.jsxs)(n.blockquote,{children:["\n",(0,d.jsx)(n.p,{children:"\u4f01\u4e1a\u7ea7\u5f3a\u5236\u7ea6\u675f\uff0c\u4e0b\u7ea7\u77e5\u8bc6\u5e93\uff08L1/L2\uff09\u4e0d\u53ef\u8986\u76d6"}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"\u4e00\u5206\u5c42\u67b6\u6784-must",children:"\u4e00\u3001\u5206\u5c42\u67b6\u6784 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"11-\u5c42\u7ea7\u4f9d\u8d56\u89c4\u5219",children:"1.1 \u5c42\u7ea7\u4f9d\u8d56\u89c4\u5219"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'rules:\n  - "\u7981\u6b62 Controller/Handler \u76f4\u63a5\u8bbf\u95ee Repository/DAO\uff08\u5fc5\u987b\u7ecf\u8fc7 Service\uff09"\n  - "\u7981\u6b62\u5faa\u73af\u4f9d\u8d56\uff08A\u2192B\u2192C\u2192A\uff09"\n  - "\u57fa\u7840\u8bbe\u65bd\u5c42\u4e0d\u5f97\u4f9d\u8d56\u4e1a\u52a1\u5c42"\n  - "\u9886\u57df\u5c42\u4e0d\u5f97\u4f9d\u8d56\u5e94\u7528\u5c42"\n'})}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502         Controller / Handler        \u2502  \u2190 \u63a5\u53e3\u5c42\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502              Service                \u2502  \u2190 \u4e1a\u52a1\u903b\u8f91\u5c42\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502         Repository / DAO            \u2502  \u2190 \u6570\u636e\u8bbf\u95ee\u5c42\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502           Infrastructure            \u2502  \u2190 \u57fa\u7840\u8bbe\u65bd\u5c42\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,d.jsx)(n.h3,{id:"12-\u7981\u6b62\u6a21\u5f0f",children:"1.2 \u7981\u6b62\u6a21\u5f0f"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u274c \u7981\u6b62\uff1aController \u76f4\u63a5\u8bbf\u95ee Mapper\n@RestController\npublic class OrderController {\n    @Autowired\n    private OrderMapper orderMapper;  // \u7981\u6b62\uff01\n\n    @GetMapping("/orders/{id}")\n    public Order getOrder(@PathVariable Long id) {\n        return orderMapper.selectById(id);\n    }\n}\n\n// \u2705 \u6b63\u786e\uff1a\u901a\u8fc7 Service \u5c42\n@RestController\npublic class OrderController {\n    @Autowired\n    private OrderService orderService;\n\n    @GetMapping("/orders/{id}")\n    public Result<OrderVO> getOrder(@PathVariable Long id) {\n        return Result.success(orderService.getOrderById(id));\n    }\n}\n'})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u4e8c\u6570\u636e\u4e00\u81f4\u6027-must",children:"\u4e8c\u3001\u6570\u636e\u4e00\u81f4\u6027 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"21-\u4e8b\u52a1\u89c4\u8303",children:"2.1 \u4e8b\u52a1\u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'rules:\n  - "\u8de8\u670d\u52a1\u6570\u636e\u4fee\u6539\u5fc5\u987b\u4f7f\u7528\u5206\u5e03\u5f0f\u4e8b\u52a1\u6216\u6700\u7ec8\u4e00\u81f4\u6027\u65b9\u6848"\n  - "\u7981\u6b62\u5728\u6570\u636e\u5e93\u4e8b\u52a1\u4e2d\u8c03\u7528\u5916\u90e8 HTTP \u670d\u52a1"\n  - "\u6240\u6709\u5199\u63a5\u53e3\u5fc5\u987b\u652f\u6301\u5e42\u7b49\u6027\uff08\u53ef\u5b89\u5168\u91cd\u8bd5\uff09"\n  - "\u5e76\u53d1\u4fee\u6539\u5fc5\u987b\u6709\u4e50\u89c2\u9501\u6216\u60b2\u89c2\u9501\u4fdd\u62a4"\n'})}),"\n",(0,d.jsx)(n.h3,{id:"22-\u4e8b\u52a1\u8fb9\u754c",children:"2.2 \u4e8b\u52a1\u8fb9\u754c"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:"// \u274c \u7981\u6b62\uff1a\u4e8b\u52a1\u5185\u8c03\u7528\u5916\u90e8\u670d\u52a1\n@Transactional(rollbackFor = Exception.class)\npublic void createOrder(OrderRequest request) {\n    orderMapper.insert(order);\n    paymentService.pay(order);  // \u5916\u90e8 HTTP \u8c03\u7528\uff0c\u53ef\u80fd\u8d85\u65f6\n    notificationService.send(order);  // \u5916\u90e8\u8c03\u7528\n}\n\n// \u2705 \u6b63\u786e\uff1a\u4e8b\u52a1\u5916\u8c03\u7528\u5916\u90e8\u670d\u52a1\n@Transactional(rollbackFor = Exception.class)\npublic Long createOrder(OrderRequest request) {\n    orderMapper.insert(order);\n    return order.getId();\n}\n\npublic void processOrder(OrderRequest request) {\n    Long orderId = createOrder(request);  // \u4e8b\u52a1\u5185\n    paymentService.pay(orderId);  // \u4e8b\u52a1\u5916\n    notificationService.send(orderId);  // \u4e8b\u52a1\u5916\n}\n"})}),"\n",(0,d.jsx)(n.h3,{id:"23-\u4e8b\u52a1\u914d\u7f6e",children:"2.3 \u4e8b\u52a1\u914d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:"// \u2705 \u6b63\u786e\uff1a\u5fc5\u987b\u6307\u5b9a rollbackFor\n@Transactional(rollbackFor = Exception.class)\npublic Long createOrder(OrderCreateRequest request) {\n    // \u4e1a\u52a1\u903b\u8f91\n}\n\n// \u274c \u9519\u8bef\uff1a\u672a\u6307\u5b9a rollbackFor\n@Transactional\npublic Long createOrder(OrderCreateRequest request) {\n    // \u4e1a\u52a1\u903b\u8f91\n}\n"})}),"\n",(0,d.jsx)(n.h3,{id:"24-\u4e50\u89c2\u9501",children:"2.4 \u4e50\u89c2\u9501"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u2705 \u6b63\u786e\uff1a\u7248\u672c\u53f7\u4e50\u89c2\u9501\n@Update("UPDATE order_info SET status = #{status}, version = version + 1 " +\n        "WHERE id = #{id} AND version = #{version}")\nint updateWithVersion(@Param("id") Long id,\n                      @Param("status") Integer status,\n                      @Param("version") Integer version);\n\npublic void updateOrderStatus(Long orderId, Integer newStatus) {\n    Order order = orderMapper.selectById(orderId);\n    int affected = orderMapper.updateWithVersion(orderId, newStatus, order.getVersion());\n    if (affected == 0) {\n        throw new ConcurrentModificationException("\u6570\u636e\u5df2\u88ab\u4fee\u6539\uff0c\u8bf7\u91cd\u8bd5");\n    }\n}\n'})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u4e09\u53ef\u89c2\u6d4b\u6027-must",children:"\u4e09\u3001\u53ef\u89c2\u6d4b\u6027 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"31-\u5065\u5eb7\u68c0\u67e5",children:"3.1 \u5065\u5eb7\u68c0\u67e5"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'rules:\n  - "\u6240\u6709\u670d\u52a1\u5fc5\u987b\u66b4\u9732\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9 /health \u6216 /actuator/health"\n  - "\u6240\u6709\u670d\u52a1\u5fc5\u987b\u63a5\u5165\u7edf\u4e00\u76d1\u63a7\u4f53\u7cfb\uff08metrics/traces/logs\uff09"\n  - "\u5173\u952e\u4e1a\u52a1\u6d41\u7a0b\u5fc5\u987b\u6709\u5168\u94fe\u8def\u8ffd\u8e2a\uff08TraceId \u8d2f\u7a7f\uff09"\n  - "\u5f02\u5e38\u5fc5\u987b\u4e0a\u62a5\u76d1\u63a7\u7cfb\u7edf\uff0c\u7981\u6b62\u9759\u9ed8\u541e\u6389"\n'})}),"\n",(0,d.jsx)(n.h3,{id:"32-k8s-\u63a2\u9488\u914d\u7f6e",children:"3.2 K8s \u63a2\u9488\u914d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"# \u5b58\u6d3b\u63a2\u9488\nlivenessProbe:\n  httpGet:\n    path: /actuator/health/liveness\n    port: 8080\n  initialDelaySeconds: 60\n  periodSeconds: 10\n  failureThreshold: 3\n\n# \u5c31\u7eea\u63a2\u9488\nreadinessProbe:\n  httpGet:\n    path: /actuator/health/readiness\n    port: 8080\n  initialDelaySeconds: 30\n  periodSeconds: 5\n  failureThreshold: 3\n"})}),"\n",(0,d.jsx)(n.h3,{id:"33-\u94fe\u8def\u8ffd\u8e2a",children:"3.3 \u94fe\u8def\u8ffd\u8e2a"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u2705 \u6b63\u786e\uff1aFeign \u62e6\u622a\u5668\u4f20\u9012\u94fe\u8def ID\n@Component\npublic class FeignTraceInterceptor implements RequestInterceptor {\n    @Override\n    public void apply(RequestTemplate template) {\n        String traceId = MDC.get("traceId");\n        if (StringUtils.isNotBlank(traceId)) {\n            template.header("X-Trace-Id", traceId);\n        }\n    }\n}\n'})}),"\n",(0,d.jsx)(n.h3,{id:"34-\u65e5\u5fd7\u683c\u5f0f\u89c4\u8303",children:"3.4 \u65e5\u5fd7\u683c\u5f0f\u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'rules:\n  - "\u6240\u6709\u670d\u52a1\u5fc5\u987b\u4f7f\u7528\u7edf\u4e00\u65e5\u5fd7\u683c\u5f0f"\n  - "\u65e5\u5fd7\u5fc5\u987b\u5305\u542b traceId\u3001spanId"\n  - "\u7981\u6b62\u65e5\u5fd7\u660e\u6587\u6253\u5370\u654f\u611f\u6570\u636e"\n  - "\u65e5\u5fd7\u7ea7\u522b\uff1aERROR\uff08\u5f02\u5e38\uff09\u3001WARN\uff08\u8b66\u544a\uff09\u3001INFO\uff08\u5173\u952e\u6d41\u7a0b\uff09\u3001DEBUG\uff08\u8c03\u8bd5\uff09"\n'})}),"\n",(0,d.jsx)(n.h4,{id:"341-logback-\u914d\u7f6e",children:"3.4.1 Logback \u914d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-xml",children:'\x3c!-- logback-spring.xml --\x3e\n<configuration>\n    <property name="LOG_PATTERN"\n              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - [traceId:%X{traceId}] [spanId:%X{spanId}] - %msg%n"/>\n\n    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">\n        <encoder>\n            <pattern>${LOG_PATTERN}</pattern>\n            <charset>UTF-8</charset>\n        </encoder>\n    </appender>\n\n    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">\n        <file>${LOG_PATH}/app.log</file>\n        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">\n            <fileNamePattern>${LOG_PATH}/app.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>\n            <maxFileSize>100MB</maxFileSize>\n            <maxHistory>30</maxHistory>\n            <totalSizeCap>10GB</totalSizeCap>\n        </rollingPolicy>\n        <encoder>\n            <pattern>${LOG_PATTERN}</pattern>\n            <charset>UTF-8</charset>\n        </encoder>\n    </appender>\n</configuration>\n'})}),"\n",(0,d.jsx)(n.h4,{id:"342-\u65e5\u5fd7\u5b57\u6bb5\u89c4\u8303",children:"3.4.2 \u65e5\u5fd7\u5b57\u6bb5\u89c4\u8303"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u5b57\u6bb5"}),(0,d.jsx)(n.th,{children:"\u957f\u5ea6"}),(0,d.jsx)(n.th,{children:"\u683c\u5f0f"}),(0,d.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"traceId"}),(0,d.jsx)(n.td,{children:"32 \u4f4d"}),(0,d.jsx)(n.td,{children:"\u5c0f\u5199\u5341\u516d\u8fdb\u5236"}),(0,d.jsx)(n.td,{children:"\u5168\u94fe\u8def\u552f\u4e00\u6807\u8bc6\uff0c\u8de8\u670d\u52a1\u4f20\u9012"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"spanId"}),(0,d.jsx)(n.td,{children:"16 \u4f4d"}),(0,d.jsx)(n.td,{children:"\u5c0f\u5199\u5341\u516d\u8fdb\u5236"}),(0,d.jsx)(n.td,{children:"\u5355\u6b21\u8c03\u7528\u6807\u8bc6"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"timestamp"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"yyyy-MM-dd HH:mm:ss.SSS"})}),(0,d.jsx)(n.td,{children:"\u6beb\u79d2\u7ea7\u65f6\u95f4\u6233"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"level"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:(0,d.jsx)(n.code,{children:"ERROR/WARN/INFO/DEBUG"})}),(0,d.jsx)(n.td,{children:"\u65e5\u5fd7\u7ea7\u522b"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"thread"}),(0,d.jsx)(n.td,{children:"-"}),(0,d.jsx)(n.td,{children:"\u7ebf\u7a0b\u540d"}),(0,d.jsx)(n.td,{children:"\u5f53\u524d\u7ebf\u7a0b"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"logger"}),(0,d.jsx)(n.td,{children:"36 \u4f4d\u622a\u65ad"}),(0,d.jsx)(n.td,{children:"\u7c7b\u5168\u9650\u5b9a\u540d"}),(0,d.jsx)(n.td,{children:"\u65e5\u5fd7\u6765\u6e90"})]})]})]}),"\n",(0,d.jsx)(n.h4,{id:"343-traceid-\u751f\u6210\u4e0e\u4f20\u9012",children:"3.4.3 TraceId \u751f\u6210\u4e0e\u4f20\u9012"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u2705 \u6b63\u786e\uff1a\u7f51\u5173\u5c42\u751f\u6210 TraceId\n@Component\npublic class TraceFilter implements GlobalFilter, Ordered {\n    @Override\n    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {\n        String traceId = exchange.getRequest().getHeaders().getFirst("X-Trace-Id");\n        if (StringUtils.isBlank(traceId)) {\n            traceId = generateTraceId();  // 32 \u4f4d\u5c0f\u5199\u5341\u516d\u8fdb\u5236\n        }\n\n        ServerHttpRequest request = exchange.getRequest().mutate()\n            .header("X-Trace-Id", traceId)\n            .build();\n\n        return chain.filter(exchange.mutate().request(request).build());\n    }\n\n    private String generateTraceId() {\n        return UUID.randomUUID().toString().replace("-", "");\n    }\n}\n\n// \u2705 \u6b63\u786e\uff1a\u670d\u52a1\u5c42\u63a5\u6536\u5e76\u653e\u5165 MDC\n@Component\npublic class TraceInterceptor implements HandlerInterceptor {\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {\n        String traceId = request.getHeader("X-Trace-Id");\n        String spanId = generateSpanId();  // 16 \u4f4d\u5c0f\u5199\u5341\u516d\u8fdb\u5236\n\n        MDC.put("traceId", traceId);\n        MDC.put("spanId", spanId);\n        return true;\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response,\n                                 Object handler, Exception ex) {\n        MDC.clear();  // \u5fc5\u987b\u6e05\u7406\n    }\n}\n'})}),"\n",(0,d.jsx)(n.h4,{id:"344-\u65e5\u5fd7\u7ea7\u522b\u4f7f\u7528\u89c4\u8303",children:"3.4.4 \u65e5\u5fd7\u7ea7\u522b\u4f7f\u7528\u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// ERROR\uff1a\u7cfb\u7edf\u5f02\u5e38\u3001\u4e1a\u52a1\u5f02\u5e38\u3001\u9700\u8981\u544a\u8b66\nlog.error("\u521b\u5efa\u8ba2\u5355\u5931\u8d25, userId={}, request={}", userId, JSON.toJSONString(request), e);\n\n// WARN\uff1a\u53ef\u6062\u590d\u5f02\u5e38\u3001\u964d\u7ea7\u3001\u91cd\u8bd5\nlog.warn("\u8c03\u7528\u652f\u4ed8\u670d\u52a1\u8d85\u65f6\uff0c\u89e6\u53d1\u91cd\u8bd5, orderId={}, retryCount={}", orderId, retryCount);\n\n// INFO\uff1a\u5173\u952e\u4e1a\u52a1\u8282\u70b9\u3001\u5165\u53e3\u51fa\u53e3\nlog.info("\u8ba2\u5355\u521b\u5efa\u6210\u529f, orderId={}, userId={}, amount={}", orderId, userId, amount);\n\n// DEBUG\uff1a\u8c03\u8bd5\u4fe1\u606f\uff08\u751f\u4ea7\u73af\u5883\u9ed8\u8ba4\u5173\u95ed\uff09\nlog.debug("\u67e5\u8be2\u53c2\u6570, query={}", JSON.toJSONString(query));\n'})}),"\n",(0,d.jsx)(n.h4,{id:"345-\u654f\u611f\u6570\u636e\u8131\u654f",children:"3.4.5 \u654f\u611f\u6570\u636e\u8131\u654f"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u274c \u7981\u6b62\uff1a\u660e\u6587\u6253\u5370\u654f\u611f\u6570\u636e\nlog.info("\u7528\u6237\u767b\u5f55, phone={}, password={}", phone, password);\n\n// \u2705 \u6b63\u786e\uff1a\u8131\u654f\u540e\u6253\u5370\nlog.info("\u7528\u6237\u767b\u5f55, phone={}", DesensitizeUtils.maskPhone(phone));\n\n// \u8131\u654f\u89c4\u5219\n// \u624b\u673a\u53f7\uff1a138****8000\n// \u8eab\u4efd\u8bc1\uff1a310***********1234\n// \u94f6\u884c\u5361\uff1a************1234\n'})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u56db\u5bb9\u9519\u97e7\u6027-must",children:"\u56db\u3001\u5bb9\u9519\u97e7\u6027 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"41-\u8d85\u65f6\u4e0e\u7194\u65ad",children:"4.1 \u8d85\u65f6\u4e0e\u7194\u65ad"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'rules:\n  - "\u5916\u90e8\u4f9d\u8d56\u8c03\u7528\u5fc5\u987b\u8bbe\u7f6e\u8d85\u65f6\u65f6\u95f4"\n  - "\u6838\u5fc3\u94fe\u8def\u5fc5\u987b\u6709\u964d\u7ea7\u65b9\u6848"\n  - "\u7981\u6b62\u5355\u70b9\u6545\u969c\uff08\u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001MQ \u7b49\uff09"\n'})}),"\n",(0,d.jsx)(n.h3,{id:"42-feign-\u8d85\u65f6\u914d\u7f6e",children:"4.2 Feign \u8d85\u65f6\u914d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"spring:\n  cloud:\n    openfeign:\n      client:\n        config:\n          default:\n            connect-timeout: 3000\n            read-timeout: 5000\n          mall-order:\n            read-timeout: 8000\n"})}),"\n",(0,d.jsx)(n.h3,{id:"43-\u7194\u65ad\u964d\u7ea7",children:"4.3 \u7194\u65ad\u964d\u7ea7"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-java",children:'// \u2705 \u6b63\u786e\uff1aFallbackFactory \u83b7\u53d6\u5f02\u5e38\u4fe1\u606f\n@Component\npublic class OrderFeignFallbackFactory implements FallbackFactory<OrderFeignApi> {\n    @Override\n    public OrderFeignApi create(Throwable cause) {\n        return new OrderFeignApi() {\n            @Override\n            public Result<OrderDetailDTO> getOrderDetail(Long orderId) {\n                log.error("\u7194\u65ad\uff1a\u8c03\u7528\u8ba2\u5355\u670d\u52a1\u5931\u8d25\uff0corderId:{}, cause:{}",\n                         orderId, cause.getMessage());\n                return Result.fail(503, "\u8ba2\u5355\u670d\u52a1\u6682\u65f6\u4e0d\u53ef\u7528");\n            }\n        };\n    }\n}\n\n// \u274c \u9519\u8bef\uff1a\u65e0\u964d\u7ea7\u5904\u7406\n@FeignClient(name = "mall-order")\npublic interface OrderFeignApi { }\n'})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u4e94\u5fae\u670d\u52a1\u901a\u4fe1-must",children:"\u4e94\u3001\u5fae\u670d\u52a1\u901a\u4fe1 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"51-\u6ce8\u518c\u4e2d\u5fc3",children:"5.1 \u6ce8\u518c\u4e2d\u5fc3"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"required: Nacos \u96c6\u7fa4\uff08\u22653\u8282\u70b9\uff09\nrules:\n  - \u670d\u52a1\u540d\u683c\u5f0f\uff1a\u4e1a\u52a1\u7ebf-\u670d\u52a1\u540d\uff08\u5982 mall-order\uff09\n  - \u547d\u540d\u7a7a\u95f4\uff1a\u6309\u73af\u5883\u9694\u79bb\uff08dev/test/prod\uff09\n  - \u5206\u7ec4\uff1a\u6309\u4e1a\u52a1\u7ebf\u5206\u7ec4\n  - \u5065\u5eb7\u68c0\u67e5\uff1a\u5fc3\u8df3\u95f4\u9694 5 \u79d2\uff0c\u8d85\u65f6 15 \u79d2\n"})}),"\n",(0,d.jsx)(n.h3,{id:"52-feign-\u89c4\u8303",children:"5.2 Feign \u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"rules:\n  - \u72ec\u7acb API \u6a21\u5757\uff08\u4ec5\u542b Feign \u63a5\u53e3\u3001DTO\u3001\u679a\u4e3e\uff09\n  - \u5fc5\u987b\u914d\u7f6e FallbackFactory\n  - \u7981\u6b62\u5199\u64cd\u4f5c\u5f00\u542f\u91cd\u8bd5\n  - \u94fe\u8def ID \u5fc5\u987b\u4f20\u9012\n"})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u516d\u5bb9\u5668\u5316\u90e8\u7f72-must",children:"\u516d\u3001\u5bb9\u5668\u5316\u90e8\u7f72 [MUST]"}),"\n",(0,d.jsx)(n.h3,{id:"61-dockerfile-\u89c4\u8303",children:"6.1 Dockerfile \u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-dockerfile",children:'# \u2705 \u6b63\u786e\uff1a\u591a\u9636\u6bb5\u6784\u5efa + \u975e root \u7528\u6237\nFROM maven:3.8.5-openjdk-17 AS builder\nWORKDIR /build\nCOPY pom.xml .\nRUN mvn dependency:go-offline\nCOPY src ./src\nRUN mvn clean package -DskipTests\n\nFROM eclipse-temurin:17-jre-alpine\nRUN addgroup -S app && adduser -S app -G app\nUSER app\nCOPY --from=builder /build/target/*.jar /app/app.jar\nHEALTHCHECK --interval=30s --timeout=3s \\\n    CMD curl -f http://localhost:8080/actuator/health || exit 1\nENTRYPOINT ["java", "-jar", "/app/app.jar"]\n'})}),"\n",(0,d.jsx)(n.h3,{id:"62-k8s-\u5b89\u5168\u914d\u7f6e",children:"6.2 K8s \u5b89\u5168\u914d\u7f6e"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:'securityContext:\n  runAsNonRoot: true\n  runAsUser: 1000\n  readOnlyRootFilesystem: true\n  allowPrivilegeEscalation: false\n\nresources:\n  requests:\n    cpu: "500m"\n    memory: "1Gi"\n  limits:\n    cpu: "2"\n    memory: "2Gi"\n'})}),"\n",(0,d.jsx)(n.h3,{id:"63-\u955c\u50cf\u6807\u7b7e\u89c4\u8303",children:"6.3 \u955c\u50cf\u6807\u7b7e\u89c4\u8303"}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-yaml",children:"format: \u7248\u672c\u53f7-CommitID\nexample: v1.0.0-7a3f2d9\nprohibited:\n  - latest\n  - dev\n  - test\n"})}),"\n",(0,d.jsx)(n.hr,{}),"\n",(0,d.jsx)(n.h2,{id:"\u4e03\u53cd\u6a21\u5f0f\u68c0\u67e5\u6e05\u5355",children:"\u4e03\u3001\u53cd\u6a21\u5f0f\u68c0\u67e5\u6e05\u5355"}),"\n",(0,d.jsxs)(n.table,{children:[(0,d.jsx)(n.thead,{children:(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.th,{children:"\u5e8f\u53f7"}),(0,d.jsx)(n.th,{children:"\u53cd\u6a21\u5f0f"}),(0,d.jsx)(n.th,{children:"\u68c0\u6d4b\u65b9\u5f0f"})]})}),(0,d.jsxs)(n.tbody,{children:[(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"1"}),(0,d.jsx)(n.td,{children:"Controller \u76f4\u63a5\u8bbf\u95ee Mapper"}),(0,d.jsx)(n.td,{children:"\u4ee3\u7801\u5ba1\u67e5"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"2"}),(0,d.jsx)(n.td,{children:"\u4e8b\u52a1\u5185\u8c03\u7528\u5916\u90e8\u670d\u52a1"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 @Transactional \u65b9\u6cd5\u5185\u7684 HTTP \u8c03\u7528"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"3"}),(0,d.jsx)(n.td,{children:"\u672a\u6307\u5b9a rollbackFor"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 @Transactional \u6ce8\u89e3"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"4"}),(0,d.jsx)(n.td,{children:"Nacos \u5355\u8282\u70b9\u90e8\u7f72"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 server-addr \u914d\u7f6e"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"5"}),(0,d.jsx)(n.td,{children:"Feign \u5199\u64cd\u4f5c\u5f00\u542f\u91cd\u8bd5"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5\u91cd\u8bd5\u7b56\u7565\u914d\u7f6e"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"6"}),(0,d.jsx)(n.td,{children:"\u65e0 FallbackFactory"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 FeignClient \u6ce8\u89e3"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"7"}),(0,d.jsx)(n.td,{children:"\u5bb9\u5668 root \u7528\u6237\u8fd0\u884c"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 Dockerfile"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"8"}),(0,d.jsx)(n.td,{children:"\u65e0\u5065\u5eb7\u68c0\u67e5\u63a2\u9488"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 K8s Deployment"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"9"}),(0,d.jsx)(n.td,{children:"\u955c\u50cf\u6807\u7b7e\u7528 latest"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 Deployment \u914d\u7f6e"})]}),(0,d.jsxs)(n.tr,{children:[(0,d.jsx)(n.td,{children:"10"}),(0,d.jsx)(n.td,{children:"\u65e0\u8d44\u6e90\u9650\u5236"}),(0,d.jsx)(n.td,{children:"\u68c0\u67e5 resources \u914d\u7f6e"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(o,{...e})}):o(e)}},8453(e,n,r){r.d(n,{R:()=>i,x:()=>s});var l=r(6540);const d={},t=l.createContext(d);function i(e){const n=l.useContext(t);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:i(e.components),l.createElement(t.Provider,{value:n},e.children)}}}]);